<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 配合Travis CI，将Hexo博客自动部署到你的服务器上。 · Makito的笔记本</title><meta name="description" content="配合Travis CI，将Hexo博客自动部署到你的服务器上。 - Sumi Makito"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">MAKITO的笔记本</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/links" target="_self" class="nav-list-link">链接</a></li><li class="nav-list-item"><a href="http://weibo.com/u/2393492311" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="https://github.com/sumimakito" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">配合Travis CI，将Hexo博客自动部署到你的服务器上。</h1><div class="post-time">2015年11月6日</div><div class="post-content"><blockquote>
<p>这篇教程将指导你如何将写好的文章通过Git提交至GitHub仓库，并使用Travis CI自动构建、部署到你的服务器上。</p>
</blockquote>
<p>今年夏天的时候，为了多练习Python，于是用就它写了一个简单的静态博客生成器，有模板有标签，不过与现有的静态博客相比还是相形见绌。即不易管理，也总出现BUG。</p>
<p>博客是需要静下心来写的，程序总需要维护实在不是长计，于是，昨天我便把博客换成了Hexo。<del>终于可以安静的写博客了。</del></p>
<p>Hexo是一个基于Node.js的博客框架，从模板、主题再到插件应有尽有，写好文章后可以得到一个静态整站，对于像个人博客这种更新需求不大的网站是再适合不过了。</p>
<p>网上给出的教程多是将博客托管于GitHub Pages上，然而GitHub Pages在国内部分地区以及部分运营商的网络下的表现有时并不完美，经常出现载入缓慢，CSS及JS无法载入的问题，因此也有部分人选择将博客放在自己的服务器上。</p>
<p>但是在个人服务器上搭建博客又要考虑一个非常重要的问题——备份数据。GitHub提供的版本控制功能非常强大，但是个人服务器上大都没有使用版本控制系统，需要自行备份。</p>
<p>为什么不把GitHub的强大版本控制功能与个人服务器的访问速度结合在一起呢？</p>
<a id="more"></a>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>本教程并不是为初学者准备的，因为其需要的步骤较多且较复杂，需要读者有使用Git及GitHub的经验，并了解PHP及Bash。</p>
<h3 id="0x00-新的开始"><a href="#0x00-新的开始" class="headerlink" title="0x00 新的开始"></a>0x00 新的开始</h3><p>新建一个代码仓库，我们暂且取名为 <code>HexoBlog</code> 好了。<br>为了使仓库更简洁，我们可以在<code>master</code>分支的基础上新建一个分支，暂且取名为 <code>raw</code> 分支。</p>
<h3 id="0x01-Clone到本地"><a href="#0x01-Clone到本地" class="headerlink" title="0x01 Clone到本地"></a>0x01 Clone到本地</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">-b</span> raw <span class="tag">&lt;仓库克隆URL&gt;</span> <span class="comment">#只Clone出新建的raw分支 保留master分支用于部署</span></span><br></pre></td></tr></table></figure>
<h3 id="0x02-安装Node-js"><a href="#0x02-安装Node-js" class="headerlink" title="0x02 安装Node.js"></a>0x02 安装Node.js</h3><p>Node.js的版本仍在不断更新中，请至<a href="https://nodejs.org/en/download/" target="_blank" rel="external">项目下载页</a>寻找合适系统架构的安装包。</p>
<p>安装包自带包管理器NPM。</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/02.00.png" alt="Node.js与NPM的版本"></p>
<p>安装后可以在Terminal中查询Node.js与NPM的版本。</p>
<h3 id="0x03-安装Hexo"><a href="#0x03-安装Hexo" class="headerlink" title="0x03 安装Hexo"></a>0x03 安装Hexo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./HexoB<span class="built_in">log</span> <span class="comment">#进入刚Clone的仓库目录</span></span><br><span class="line">npm install hexo-cli -g</span><br><span class="line">hexo init</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
<blockquote>
<p>若 <code>NPM</code> 出现无法连接的问题，可以尝试<a href="http://npm.taobao.org/" target="_blank" rel="external">更换淘宝开源NPM镜像服务器</a></p>
</blockquote>
<p>接下来我们可以看到仓库中的文件结构</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/03.00.png" alt="文件结构"></p>
<h3 id="0x04-使用Travis-CI"><a href="#0x04-使用Travis-CI" class="headerlink" title="0x04 使用Travis CI"></a>0x04 使用Travis CI</h3><p>首先我们先打开<a href="https://travis-ci.org/" target="_blank" rel="external">Travis CI</a>，可以在右上角找到使用GitHub登陆的按钮。</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/04.00.png" alt="Travis CI首页"></p>
<p>授权完成后，你可以在左上角找到My Repositories一旁的加号“+”，点击它，它就会列出你所有的仓库，你只需要找到刚才的 <code>HexoBlog</code> 并把它左侧的开关打开就可以了。</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/04.01.png" alt="添加仓库"></p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/04.02.png" alt="选择仓库"></p>
<h3 id="0x05-生成GitHub-Personal-Access-Token"><a href="#0x05-生成GitHub-Personal-Access-Token" class="headerlink" title="0x05 生成GitHub Personal Access Token"></a>0x05 生成GitHub Personal Access Token</h3><p>登录GitHub，在右上角头像处进入设置。</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/05.00.png" alt="进入设置"></p>
<p>在左侧找到 <code>Personal access tokens</code>，并点击右上角的 <code>Generate new token</code>。</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/05.01.png" alt="Personal access tokens"></p>
<p>需要为新的Token输入一个名字，这里我们就填入 <code>Travis CI</code> 好了。</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/05.02.png" alt="Generate new token"></p>
<p>确定生成后，Token将显示在页面上，此时需要将其复制并保存好，并避免泄露。遗忘Token后不能找回，只能重新生成。</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/05.03.png" alt="生成Token"></p>
<p>最后，我们还需要<a href="https://www.random.org/strings/?num=10&amp;len=20&amp;digits=on&amp;upperalpha=on&amp;loweralpha=on&amp;unique=on&amp;format=html&amp;rnd=new" target="_blank" rel="external">生成随机字符串</a>，并在其中选择一行随机字符串，为下文备用。</p>
<h3 id="0x06-配置Travis-CI"><a href="#0x06-配置Travis-CI" class="headerlink" title="0x06 配置Travis CI"></a>0x06 配置Travis CI</h3><p>首先在Travis CI中找到已经启用自动构建的仓库，并在右侧找到设置按钮。</p>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/06.00.png" alt="设置按钮"></p>
<p>有两处需要设置，首先需要启用 <code>Build only if .travis.yml is present</code> 选项，以避免 <code>master</code> 分支被构建和陷入构建循环的问题。</p>
<p>另外，在下方的环境变量设置处，我们需要设置两组变量，并注意保持 <code>Display value in build log</code> 禁用，以免构建日志泄露Token等信息。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要设置的两组变量</span></span><br><span class="line"><span class="attr">GitHubKEY</span> = 上文生成的GitHub Personal Access Token</span><br><span class="line"><span class="attr">NOTIFY_TOKEN</span> = 上文生成的随机字符串</span><br></pre></td></tr></table></figure>
<p><img src="http://internal-static.keep.moe/blog.keep.moe/20151106_hexo-and-travis-ci/06.01.png" alt="设置页面"></p>
<p>在每次Push后，Travis CI将检查分支下的 <code>.travis.yml</code> 文件，并以此作为配置进行构建。</p>
<p>下面是我所使用的 <code>.travis.yml</code> :</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> node_js</span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"0.12"</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line"><span class="bullet">  -</span> npm install hexo-cli -g</span><br><span class="line"><span class="bullet">  -</span> npm install hexo --save</span><br><span class="line"><span class="bullet">  -</span> npm install</span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">  -</span> chmod +x ./build.sh</span><br><span class="line"><span class="bullet">  -</span> ./build.sh &gt; /dev/<span class="literal">null</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> raw</span><br></pre></td></tr></table></figure>
<p>有关于Travis CI配置的详细解释可以查阅<a href="http://docs.travis-ci.com/" target="_blank" rel="external">官方文档</a></p>
<p>在这里，配置文件限制了自动构建工作只会在 <code>raw</code> 分支下进行。</p>
<p>可能你已经发现配置中的 <code>build.sh</code> 了，我们接下来就介绍一下这个文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hexo generate <span class="comment">#生成静态整站</span></span><br><span class="line"><span class="built_in">cd</span> ./public <span class="comment">#生成的静态页面会存储在public目录下</span></span><br><span class="line">git init</span><br><span class="line">git config --global push.default matching</span><br><span class="line">git config --global user.email <span class="string">"username@example.com"</span> <span class="comment">#填入GitHub的邮箱地址</span></span><br><span class="line">git config --global user.name <span class="string">"username"</span> <span class="comment">#填入GitHub的用户名</span></span><br><span class="line">git add --all .</span><br><span class="line">git commit -m <span class="string">"Travis CI Auto Builder"</span> <span class="comment">#自动构建后的内容将全部以此信息提交</span></span><br><span class="line">git push --quiet --force https://<span class="variable">$&#123;GitHubKEY&#125;</span>@github.com/你的GitHub用户名/你的代码仓库名.git master  <span class="comment">#自动构建后的内容将全部以此信息提交</span></span><br><span class="line">curl --connect-timeout 20 --max-time 30 <span class="_">-s</span> http://远端服务器URL/webhook.php?_=<span class="variable">$&#123;NOTIFY_TOKEN&#125;</span> <span class="comment">#服务器Webhook 将在下文介绍</span></span><br></pre></td></tr></table></figure>
<h3 id="0x07-远端服务器的配置"><a href="#0x07-远端服务器的配置" class="headerlink" title="0x07 远端服务器的配置"></a>0x07 远端服务器的配置</h3><p>到这里，大部分的工作都完成了，我们只需要配置远端服务器就可以了。</p>
<p>远端服务器所需要做的工作便是将构建好的内容同步到本地，在这之前，我们每次提交到 <code>raw</code> 分支的新文章会被Travis CI取得并生成整站，再由Travis CI将整站Push回 <code>master</code> 分支。</p>
<p>因此我们只需要通知远端服务器Clone一下 <code>master</code> 分支就可以了。</p>
<p>首先我们在服务器上新建一个Bash文件，我使用的是VPS，因此以保存在 <code>/home/sync_blog.sh</code> 为例。</p>
<p>文件内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www/blog/ <span class="comment">#进入网站的根目录 假设blog文件夹是blog子域名的根目录</span></span><br><span class="line">rm -rf ./* &gt; /dev/null <span class="comment">#清理上次的文件</span></span><br><span class="line">rm -rf ./.* &gt; /dev/null <span class="comment">#清理上次的文件</span></span><br><span class="line">git <span class="built_in">clone</span> --depth=50 --branch=master https://github.com/SumiMakito/SumiMakito.github.io.git ./ <span class="comment">#从master分支Clone</span></span><br></pre></td></tr></table></figure>
<p>下一步，创建一个用PHP实现的类似于Webhook的接口，<del>为什么选择PHP？因为它是最好的语言啊！</del>很简单，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'_'</span>]==<span class="string">"上文的随机字符串"</span>)&#123;</span><br><span class="line">	shell_exec(<span class="string">"/home/sync_blog.sh &gt; /dev/null"</span>);</span><br><span class="line">	<span class="keyword">print</span>(<span class="string">"Done!"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">"Invalid token!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>假设这个PHP页面可以从 <code><a href="http://www.example.com/webhook.php" target="_blank" rel="external">http://www.example.com/webhook.php</a></code> 访问到，那么上文中 <code>build.sh</code> 中的最后一行就可以改成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --connect-timeout 20 --max-time 30 <span class="_">-s</span> http://www.example.com/webhook.php?_=<span class="variable">$&#123;NOTIFY_TOKEN&#125;</span> <span class="comment">#服务器Webhook 将在下文介绍</span></span><br></pre></td></tr></table></figure>
<h3 id="0x08-测试"><a href="#0x08-测试" class="headerlink" title="0x08 测试"></a>0x08 测试</h3><p>99%完成，只欠测试。</p>
<p>还记得之前的 <code>HexoBlog</code> 文件夹吗？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./HexoB<span class="built_in">log</span></span><br><span class="line">hexo new hello-ci <span class="comment">#本地没有Hexo的话可以直接跳过这一步</span></span><br><span class="line">vim ./<span class="built_in">source</span>/_posts/hello-ci.md</span><br><span class="line">git add --all .</span><br><span class="line">git commit -m <span class="string">"Hello, CI!"</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>这篇教程稍麻烦一些，但是也能帮助你了解Travis CI是如何简单配置并工作的。</p>
<p>在本地也可以生成整站，但这种方案对于本地无法安装Node.js及Hexo的用户来说很是方便。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/11/23/avoid-screenshot-in-android-app/" class="prev">上一篇</a><a href="/2015/11/05/openshift-eaccess-solution/" class="next">下一篇</a></div><div data-thread-key="2015/11/06/hexo-and-travis-ci/" data-title="配合Travis CI，将Hexo博客自动部署到你的服务器上。" data-url="http://blog.keep.moe/2015/11/06/hexo-and-travis-ci/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"blogkeepmoe"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2016
&nbsp;<a href="http://blog.keep.moe/">Makito的笔记本</a></p><p>使用本站文章时请遵守<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CCBY-NC-ND 4.0</a>协议。</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-73442912-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cdiv%20style%3D%22display%3Anone%3B%22%3E %3Cspan id='cnzz_stat_icon_1256726171'%3E%3C/span%3E %3C/div%3E %3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1256726171%26show%3Dpic2' type='text/javascript'%3E%3C/script%3E"));</script></body></html>